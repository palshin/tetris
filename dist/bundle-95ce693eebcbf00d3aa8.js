(()=>{"use strict";const t={keys:Object.keys},e={keysMap:{up:["w","W"],left:["a","A"],down:["s","S"],right:["d","D"],rotateClockwise:["e","E"],rotateCounterClockwise:["q","Q"]}};class s{config;callbacks=[];constructor(t=e){this.config=t,document.addEventListener("keydown",this.makeKeyEventListener("keyDown")),document.addEventListener("keyup",this.makeKeyEventListener("keyUp"))}subscribe(t,e){this.callbacks.push([t,e])}unsubscribe(t){this.callbacks=this.callbacks.filter((e=>e[1]!==t))}callCallbacks(t,e){t.forEach((t=>t(e)))}getCallbacks(t){return this.callbacks.filter((e=>e[0]===t)).map((t=>t[1]))}makeKeyEventListener(e){return s=>{const i=this.getCallbacks(e);if(0===i.length)return;const o=s.key;t.keys(this.config.keysMap).forEach((t=>{this.config.keysMap[t].includes(o)&&this.callCallbacks(i,t)}))}}}class i{x;y;constructor(t,e){this.x=t,this.y=e,Object.freeze(this)}move(t,e){const s=this.constructor;let{x:i,y:o}=this;switch(t){case"down":o+=e;break;case"up":o-=e;break;case"left":i-=e;break;case"right":i+=e}return new s(i,o)}isValid(){return this.x>-4&&this.y>-4}round(){return new(0,this.constructor)(Math.floor(this.x),Math.floor(this.y))}}const o={lightness(t,e){const s=Number.parseInt(t.replace("#",""),16),i=Math.round(2.55*e),o=(s>>16)+i,r=(s>>8&255)+i,n=(255&s)+i;return`#${(16777216+65536*(o<255?o<1?0:o:255)+256*(r<255?r<1?0:r:255)+(n<255?n<1?0:n:255)).toString(16).slice(1)}`}},r={fieldLength:400,length:650,blocksCount:10,backgroundColor:"#112233",borderColor:"#660099"},n={marginLeft:0,marginTop:0};class a{context;blockLength;blockBorderWidth;config;constructor(t,e){this.context=t,this.config={...r,...e||{}},this.blockLength=this.config.fieldLength/this.config.blocksCount,this.blockBorderWidth=.1*this.blockLength}translatePosition(t,e){return new i(t.x*this.blockLength+e.marginLeft,t.y*this.blockLength+e.marginTop)}get sidebarParameters(){const t=this.config.length-this.config.fieldLength,e=this.config.fieldLength,s=(t-4*this.blockLength)/2,i=2*this.config.fieldLength;return{x:e,y:0,width:t,height:i,padding:s,scoreX:e+s,scoreY:i/2,pointsX:e+s,pointsY:3*i/4}}clear(){this.context.fillStyle=this.config.backgroundColor;const{length:t}=this.config;this.context.fillRect(0,0,t,2*t)}drawSidebar(t,e){const{backgroundColor:s}=this.config,{x:i,y:o,width:r,padding:n,height:a,scoreX:c,scoreY:l,pointsX:h,pointsY:u}=this.sidebarParameters;this.context.save(),this.context.fillStyle="#FFFFFF",this.context.fillRect(i,o,r,a),this.context.fillStyle=s,this.context.font="30px sans-serif",this.context.fillText("Next figure",i+n,o+n),this.context.fillText("Scores",c,l),this.context.fillText(`${t}`,c+45,l+45),this.context.fillText("Level",h,u),this.context.fillText(`${e}`,h+45,u+45),this.context.restore()}drawNextBlocks(...t){const{x:e,y:s,padding:i}=this.sidebarParameters;t.forEach((t=>{this.drawBlock(t,{marginLeft:e+i,marginTop:s+2*i})}))}drawBlock(t,e=n){const{context:s}=this,{blockLength:i,blockBorderWidth:r}=this,{x:a,y:c}=this.translatePosition(t.position.round(),e);s.save(),s.fillStyle=t.color,s.fillRect(a,c,i,i),s.fillStyle=o.lightness(t.color,20),s.beginPath(),s.moveTo(a,c),s.lineTo(a+i,c),s.lineTo(a+i-r,c+r),s.lineTo(a+r,c+r),s.fill(),s.beginPath(),s.moveTo(a,c),s.lineTo(a,c+i),s.lineTo(a+r,c+i-r),s.lineTo(a+r,c+r),s.fill(),s.fillStyle=o.lightness(t.color,-20),s.beginPath(),s.moveTo(a+i,c),s.lineTo(a+i,c+i),s.lineTo(a+i-r,c+i-r),s.lineTo(a+i-r,c+r),s.fill(),s.beginPath(),s.moveTo(a+i,c+i),s.lineTo(a,c+i),s.lineTo(a+r,c+i-r),s.lineTo(a+i-r,c+i-r),s.fill(),s.restore()}}class c{position;color;constructor(t,e){this.position=t,this.color=e,Object.freeze(this)}move(t,e){return new(0,this.constructor)(this.position.move(t,e),this.color)}round(){return new(0,this.constructor)(this.position.round(),this.color)}}const l={rotate(t,e,s){let i=0;90===e&&s||270===e&&!s?i=1:180===e?i=2:(270===e&&s||90===e&&!s)&&(i=3);let o=t;for(;i;)o=this.rotate90Clockwise(o),i-=1;return o},rotate90Clockwise:t=>t[0].map(((e,s)=>t.map((t=>t[s])).reverse()))};class h{position;color;rotationAngle;matrix;constructor(t,e,s=0){this.position=t,this.color=e,this.rotationAngle=s,this.matrix=l.rotate(this.initialMatrix(),s,!0)}isValidPosition(){return this.blocks.every((t=>t.position.isValid()))}get blocks(){const t=[];return this.matrix.forEach(((e,s)=>{e.forEach(((e,o)=>{if(e){const e=new c(new i(this.position.x+s,this.position.y+o),this.color);t.push(e)}}))})),t}move(t,e){return new(0,this.constructor)(this.position.move(t,e),this.color,this.rotationAngle)}rotate(t){const e=this.constructor,s=[0,90,180,270],i=s.indexOf(this.rotationAngle),o=t?(i+1)%s.length:(i+3)%s.length;return new e(this.position,this.color,s[o])}round(){return new(0,this.constructor)(this.position.round(),this.color,this.rotationAngle)}moveToBegin(){let t=new(0,this.constructor)(new i(this.position.x,this.position.y),this.color,this.rotationAngle),e=Math.min(...t.blocks.map((t=>t.position.y)));e<0&&(t=t.move("down",Math.abs(e)),e=Math.min(...t.blocks.map((t=>t.position.y))));let s=Math.min(...t.blocks.map((t=>t.position.x)));return s<0&&(t=t.move("right",Math.abs(s)),s=Math.min(...t.blocks.map((t=>t.position.x)))),t.move("up",e).move("left",s)}}class u extends h{initialMatrix(){return[[!0,!0],[!0,!0]]}}var d;!function(t){t[t.Square=0]="Square",t[t.LeftGun=1]="LeftGun",t[t.RightGun=2]="RightGun",t[t.LeftSnake=3]="LeftSnake",t[t.RightSnake=4]="RightSnake",t[t.I=5]="I",t[t.T=6]="T"}(d||(d={}));class g extends h{initialMatrix(){return[[!1,!1,!0,!1],[!1,!1,!0,!1],[!1,!1,!0,!1],[!1,!1,!0,!1]]}}const f={keys:t=>Object.keys(t).filter((e=>"number"==typeof t[e])),values(t){return this.keys(t).map((e=>t[e]))}},k={number:(t,e)=>t+Math.floor(Math.random()*(e+1)),arrayElement(t){return t[this.number(0,t.length-1)]},arrayElements(t,e=2){const s=[...t],i=[];for(;i.length<e&&s.length>0;){const t=this.number(0,s.length-1);i.push(s[t]),s.splice(t,1)}return i}};class m extends h{initialMatrix(){return[[!0,!0,!0],[!1,!0,!1],[!1,!1,!1]]}}class x extends h{initialMatrix(){return[[!1,!1,!0],[!1,!1,!0],[!1,!0,!0]]}}class p extends h{initialMatrix(){return[[!1,!0,!1],[!1,!0,!1],[!1,!0,!0]]}}class b extends h{initialMatrix(){return[[!1,!0,!1],[!0,!0,!1],[!0,!1,!1]]}}class w extends h{initialMatrix(){return[[!1,!0,!1],[!1,!0,!0],[!1,!1,!0]]}}const y=["#0341AE","#72CB3B","#FFD500","#FF971C","#FF3213"],v={make(t,e,s){switch(t){case d.Square:return new u(e,s);case d.I:return new g(e,s);case d.T:return new m(e,s);case d.LeftGun:return new x(e,s);case d.RightGun:return new p(e,s);case d.LeftSnake:return new b(e,s);case d.RightSnake:return new w(e,s);default:return new g(e,s)}},makeRandom(t){const e=f.keys(d),s=k.arrayElement(e),i=k.arrayElement(y);return this.make(d[s],t,i)}},C={blocksCount:10,backgroundColor:"#112233",borderColor:"white",scoreMap:{1:100,2:300,3:700,4:1500}};class M{renderer;inputObserver;config;state;matrix;callbacks=[];constructor(t,e,s={}){this.renderer=t,this.inputObserver=e,this.config={...C,...s},this.state={time:0,score:0,level:1,speed:1e3,figure:{current:this.generateFigure(),next:this.generateFigure()},pressedKeys:{up:!1,down:!1,left:!1,right:!1,rotateClockwise:!1,rotateCounterClockwise:!1}},this.matrix=[];for(let t=0;t<this.config.blocksCount;t+=1){this.matrix[t]=[];for(let e=0;e<2*this.config.blocksCount;e+=1)this.matrix[t][e]=new c(new i(t,e),this.config.backgroundColor)}e.subscribe("keyDown",(t=>{this.state.pressedKeys[t]=!0})),e.subscribe("keyUp",(t=>{this.state.pressedKeys[t]=!1}))}get startPosition(){return new i(Math.floor(this.config.blocksCount/2),-2)}start(){this.state.time=Date.now(),this.draw(),this.main()}get baseSpeed(){return 1e3*this.state.level}main(){const t=Date.now();this.state.speed=this.state.pressedKeys.down?10*this.baseSpeed:this.baseSpeed,this.evolute(t-this.state.time),this.draw(),this.state.time=t,requestAnimationFrame(this.main.bind(this))}draw(){this.renderer.clear(),this.renderer.drawSidebar(this.state.score,this.state.level),this.drawBlockMatrix(),this.drawNextFigure(),this.drawBlocks(this.state.figure.current.blocks)}drawNextFigure(){this.renderer.drawNextBlocks(...this.state.figure.next.moveToBegin().blocks)}evolute(t){this.executeCallbacks();let e=this.state.figure.current;if(!e)return;this.state.pressedKeys.rotateClockwise&&this.canRotate(e,!0)&&(e=e.rotate(!0),this.state.pressedKeys.rotateClockwise=!1),this.state.pressedKeys.rotateCounterClockwise&&this.canRotate(e,!1)&&(e=e.rotate(!1),this.state.pressedKeys.rotateCounterClockwise=!1);const s=this.getSteps(t);this.state.pressedKeys.left&&this.canMove(e,"left",Math.ceil(s))&&(e=e.move("left",Math.ceil(s)),this.state.pressedKeys.left=!1),this.state.pressedKeys.right&&this.canMove(e,"right",Math.ceil(s))&&(e=e.move("right",Math.ceil(s)),this.state.pressedKeys.right=!1),this.canMove(e,"down",s)?e=e.move("down",s):this.nextTick((()=>{this.addFallenFigureToMatrix(e),this.state.figure.current=this.state.figure.next,this.state.figure.next=this.generateFigure()})),this.state.figure.current=e}getSteps(t){return this.state.speed*t/1e3/1e3}addFallenFigureToMatrix(t){t.round().blocks.forEach((t=>{this.matrix[t.position.x][t.position.y]=t})),this.removeFilledRows()}canMove(t,e,s){const i=t.move(e,s);return i.isValidPosition()&&i.blocks.every((t=>!this.hasIntersectionWithFallenBlocks(t)))&&i.blocks.every((t=>!this.goesOutOfBounds(t)))}removeFilledRows(){let t=0;for(let e=this.matrix[0].length-1;e>=0;e-=1)this.matrix.every((t=>!this.isEmptyBlock(t[e])))&&(t+=1,this.matrix.forEach((t=>t.splice(e,1))),this.matrix.forEach(((t,e)=>{const s=new c(new i(e,0),this.config.backgroundColor);t.unshift(s)})),e+=1);if(0!==t){for(let t=0;t<this.matrix.length;t+=1)for(let e=0;e<this.matrix[t].length;e+=1)this.matrix[t][e]=new c(new i(t,e),this.matrix[t][e].color);this.addScore(t)}}addScore(t){const e=this.config.scoreMap?.[t]||0;this.state.score+=e,this.state.level=Math.floor(this.state.score/5e3)+1}canRotate(t,e){const s=t.rotate(e);return s.isValidPosition()&&s.blocks.every((t=>!this.hasIntersectionWithFallenBlocks(t)))&&s.blocks.every((t=>!this.goesOutOfBounds(t)))}hasIntersectionWithFallenBlocks(t){const e=t.round(),s=this.matrix?.[e.position.x]?.[e.position.y];return!!s&&!this.isEmptyBlock(s)}goesOutOfBounds(t){const e=t.round();return!(e.position.y<=0)&&void 0===this.matrix?.[e.position.x]?.[e.position.y]}nextTick(t){this.callbacks.push(t)}executeCallbacks(){this.callbacks.forEach((t=>t())),this.callbacks.length=0}drawBlocks(t){t.forEach((t=>this.renderer.drawBlock(t)))}drawBlockMatrix(){this.matrix.forEach((t=>this.drawBlocks(t)))}generateFigure(){return v.makeRandom(this.startPosition)}isEmptyBlock(t){return t.color===this.config.backgroundColor}}document.addEventListener("DOMContentLoaded",(()=>{const t=document.querySelector("#gameField")?.getContext("2d");if(t){const e=new a(t,{fieldLength:400,length:650}),i=new s,o=new M(e,i);console.clear(),o.start()}}))})();